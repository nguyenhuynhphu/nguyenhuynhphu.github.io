<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Gift</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
</head>

<body>
    <div class="greeting">
        <button onclick="changeScreen()">Start</button>
    </div>
    <div class="wrapper">
        <div class="slide slide0">
            <p class="title">For your special day <br><span>And for the words that I haven't said yet...</span></p>
        </div>
        <div class="slide slide1"></div>
        <div class="slide slide2"></div>
        <div class="slide slide3"></div>
        <div class="slide slide4"></div>
        <div class="slide slide5"></div>
        <div class="slide slide6"></div>
        <div class="slide slide7"></div>
        <div class="slide slide8"></div>
        <div class="slide slide9"></div>

    </div>
    <div class="music">
        <audio controls autoplay="autoplay" id="myaudio">
            <source src="music.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>
    <div class="paging">
        <div class="dot selected"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
    <div class="singer">
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.1.0/rxjs.umd.js"></script>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyDYZxkq6sC8aR3WzvmT4Joaae1uosaw2DE",
        authDomain: "special-gift-1f21c.firebaseapp.com",
        projectId: "special-gift-1f21c",
        storageBucket: "special-gift-1f21c.appspot.com",
        messagingSenderId: "999902108270",
        appId: "1:999902108270:web:ddac01a3f0ebe8fc87a47f",
        measurementId: "G-CR90E2M5EX"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
</script>
<script>
    const slides = document.querySelectorAll('.slide')
    const paging = document.querySelectorAll('.dot')
    const wrapper = document.querySelector('.wrapper')
    const singer = document.querySelector('.singer')
    const { fromEvent, timer } = rxjs
    const { debounce } = rxjs.operators
    var currentIndex = 0

    const clearClass = (nodes, className) => {
        nodes.forEach(node => {
            node.classList.remove(className)
        })
    }
    const initSlide = () => {
        clearClass(slides, 'appear')
        slides[currentIndex].classList.add('appear')
        var audio = document.getElementById("myaudio");
        audio.volume = 0.2;
        audio.play()
        audio.addEventListener("ended", () => {
            clearInterval(addNodeTimer)
            clearInterval(removeNodeTimer)
        })
        setTimeout(() => {
            document.querySelector('.title').classList.add('text-appear')
            setTimeout(() => {
                document.querySelector('.title span').classList.add('text-appear')
            }, 2000)
        }, 1500)
    }
    function changeScreen() {
        document.querySelector('.greeting').style.display = 'none'
        document.querySelector('.wrapper').style.display = 'block'
        document.querySelector('.paging').style.opacity = '1'
        document.querySelector('.singer').style.opacity = '1'
        initSlide()
    }
    const setPosition = () => {
        wrapper.style.transform = `translateY(-${currentIndex * 100}vh)`
        clearClass(slides, 'appear')
        slides[currentIndex].classList.add('appear')
        clearClass(paging, 'selected')
        paging[currentIndex].classList.add('selected')
    }

    paging.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            currentIndex = index
            setPosition()
        })
    })
    const generateMusicNode = () => {
        var nodes = document.querySelectorAll('.node')
        if (nodes.length >= 20) return
        const img = document.createElement('img')
        const tmp = Math.floor(Math.random() * 6)
        const imgSrc = `./src/${tmp === 0 ? 1 : tmp}.png`
        img.src = imgSrc
        img.classList.add("node")
        img.style.left = `${Math.floor(Math.random() * 200)}px`
        singer.appendChild(img)
    }
    const removeMusicNode = () => {
        var nodes = document.querySelectorAll('.node')
        if (nodes.length <= 0) return
        singer.removeChild(nodes[0])
    }
    const addNodeTimer = setInterval(() =>
        generateMusicNode()
        , 1000)
    const removeNodeTimer = setTimeout(() => setInterval(() =>
        removeMusicNode(), 1000),
        15000
    )

    fromEvent(window, 'wheel')
        .pipe(debounce(() => timer(500)))
        .subscribe((event) => {
            if (currentIndex < 0) return
            if (event.deltaY > 0) {
                currentIndex == slides.length - 1 ? currentIndex : currentIndex++
            } else {
                currentIndex == 0 ? currentIndex : currentIndex--
            }
            setPosition()
        })
    slides.forEach(slide => {
        const img = slide.querySelector('img') || null
        if (img) {
            fromEvent(window, 'mousemove').pipe(debounce(() => timer(50))).subscribe((e) => {
                img.style.transform = `translateX(${-e.offsetX}px)`;
                img.style.transform = `translateY(${-e.offsetX}px)`;
            })
        }
    })
</script>

</html>